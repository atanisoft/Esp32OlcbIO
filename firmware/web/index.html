<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ESP32 OpenLCB IO Configuration Portal</title>
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml;charset=US-ASCII,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22iso-8859-1%22%3F%3E%3C!DOCTYPE%20svg%20PUBLIC%20%22-%2F%2FW3C%2F%2FDTD%20SVG%201.1%2F%2FEN%22%20%22http%3A%2F%2Fwww.w3.org%2FGraphics%2FSVG%2F1.1%2FDTD%2Fsvg11.dtd%22%3E%3Csvg%20version%3D%221.1%22%20id%3D%22Layer_1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20x%3D%220px%22%20y%3D%220px%22%20%20width%3D%2214px%22%20height%3D%2214px%22%20viewBox%3D%220%200%2014%2014%22%20style%3D%22enable-background%3Anew%200%200%2014%2014%3B%22%20xml%3Aspace%3D%22preserve%22%3E%3Cpath%20d%3D%22M13.621%2C5.904l-1.036-0.259c-0.168-0.042-0.303-0.168-0.355-0.332c-0.092-0.284-0.205-0.559-0.339-0.82%20c-0.079-0.153-0.073-0.337%2C0.017-0.486l0.549-0.915c0.118-0.196%2C0.088-0.448-0.075-0.61l-0.862-0.863%20c-0.162-0.163-0.414-0.193-0.611-0.075l-0.916%2C0.55C9.844%2C2.182%2C9.659%2C2.188%2C9.506%2C2.109C9.244%2C1.975%2C8.97%2C1.861%2C8.686%2C1.77%20c-0.165-0.052-0.29-0.187-0.332-0.354L8.095%2C0.379C8.039%2C0.156%2C7.839%2C0%2C7.609%2C0H6.391c-0.229%2C0-0.43%2C0.156-0.485%2C0.379L5.646%2C1.415%20C5.604%2C1.582%2C5.479%2C1.718%2C5.313%2C1.77c-0.284%2C0.092-0.559%2C0.206-0.82%2C0.34C4.339%2C2.188%2C4.155%2C2.182%2C4.007%2C2.093L3.092%2C1.544%20c-0.196-0.118-0.448-0.087-0.61%2C0.075L1.619%2C2.481C1.457%2C2.644%2C1.426%2C2.896%2C1.544%2C3.093l0.549%2C0.914%20c0.089%2C0.148%2C0.095%2C0.332%2C0.017%2C0.486C1.975%2C4.755%2C1.861%2C5.029%2C1.77%2C5.314c-0.053%2C0.164-0.188%2C0.29-0.354%2C0.332L0.379%2C5.905%20C0.156%2C5.961%2C0%2C6.161%2C0%2C6.391v1.219c0%2C0.229%2C0.156%2C0.43%2C0.379%2C0.485l1.036%2C0.26C1.582%2C8.396%2C1.717%2C8.521%2C1.77%2C8.687%20c0.092%2C0.284%2C0.205%2C0.559%2C0.34%2C0.82C2.188%2C9.66%2C2.182%2C9.844%2C2.093%2C9.993l-0.549%2C0.915c-0.118%2C0.195-0.087%2C0.448%2C0.075%2C0.61%20l0.862%2C0.862c0.162%2C0.163%2C0.414%2C0.193%2C0.61%2C0.075l0.915-0.549c0.148-0.089%2C0.332-0.095%2C0.486-0.017%20c0.262%2C0.135%2C0.536%2C0.248%2C0.82%2C0.34c0.165%2C0.053%2C0.291%2C0.187%2C0.332%2C0.354l0.259%2C1.036C5.96%2C13.844%2C6.16%2C14%2C6.39%2C14h1.22%20c0.229%2C0%2C0.43-0.156%2C0.485-0.379l0.259-1.036c0.042-0.167%2C0.168-0.302%2C0.333-0.354c0.284-0.092%2C0.559-0.205%2C0.82-0.34%20c0.154-0.078%2C0.338-0.072%2C0.486%2C0.017l0.914%2C0.549c0.197%2C0.118%2C0.449%2C0.088%2C0.611-0.074l0.862-0.863%20c0.163-0.162%2C0.193-0.415%2C0.075-0.611l-0.549-0.915c-0.089-0.148-0.096-0.332-0.017-0.485c0.134-0.263%2C0.248-0.536%2C0.339-0.82%20c0.053-0.165%2C0.188-0.291%2C0.355-0.333l1.036-0.259C13.844%2C8.039%2C14%2C7.839%2C14%2C7.609V6.39C14%2C6.16%2C13.844%2C5.96%2C13.621%2C5.904z%20M7%2C10%20c-1.657%2C0-3-1.343-3-3s1.343-3%2C3-3s3%2C1.343%2C3%2C3S8.657%2C10%2C7%2C10z%22%2F%3E%3Cg%3E%3C%2Fg%3E%3Cg%3E%3C%2Fg%3E%3Cg%3E%3C%2Fg%3E%3Cg%3E%3C%2Fg%3E%3Cg%3E%3C%2Fg%3E%3Cg%3E%3C%2Fg%3E%3Cg%3E%3C%2Fg%3E%3Cg%3E%3C%2Fg%3E%3Cg%3E%3C%2Fg%3E%3Cg%3E%3C%2Fg%3E%3Cg%3E%3C%2Fg%3E%3Cg%3E%3C%2Fg%3E%3Cg%3E%3C%2Fg%3E%3Cg%3E%3C%2Fg%3E%3Cg%3E%3C%2Fg%3E%3C%2Fsvg%3E"
        sizes="any">
    <script src="cash.min.js"></script>
    <script src="cdi.js"></script>
    <link rel="stylesheet" href="spectre.min.css">
    <style>
        fieldset {
          border-style: solid;
          border-width: 0.1rem;
          border-color: #606c76;
          border-radius: 0.5rem;
        }

        #ws-status.flash {
            animation-name: colorflash;
            animation-duration: 1s;
            animation-iteration-count: infinite;
            animation-timing-function: linear;
        }

        @keyframes colorflash {
            0% {
                filter: invert(0.8) sepia(1) saturate(3);
            }

            50% {
                filter: invert(0.5);
            }

            100% {
                filter: invert(0.8) sepia(1) saturate(3);
            }
        }
    </style>
</head>

<body class="bg-dark">
    <div class="hero hero-sm">
        <div class="hero-body">
            <h1>ESP32 IO Board Configuration
                <div class="btn-group float-right">
                    <div class="tooltip tooltip-left" data-tooltip="Connection status"><i id="ws-status"
                        class="icon icon-wifi text-dark"></i></div>
                </div>
            </h1>
        </div>
    </div>
    <header class="navbar">
        <section class="navbar-section btn-group">
          <button class="btn btn-primary" onclick="showTab('#tab-nodeinfo', this);">Node Information</button>
          <button class="btn btn-primary" onclick="showTab('#tab-olcbconfig', this);">OpenLCB Configuration</button>
          <button class="btn btn-primary" onclick="showTab('#tab-ota', this);">Firmware Update</button>
        </section>
    </header>
    <div class="container">
        <div class="container" id="tab-nodeinfo">
            <div class="columns">
                <div class="column"><label class="form-label" for="node_id">Node ID:</label></div>
                <div class="column column-6"><input class="form-input" id="node_id" value="PENDING" oninput="enable_button('save_node_id');">
                </div>
                <div class="column"><button class="btn btn-primary btn-sm" id="btn-save_node_id" disabled
                    onclick="save_node_id(this);">Save</button></div>
              </div>
              <div class="columns">
                <div class="column"><label class="form-label" for="sw_version">Software Version:</label></div>
                <div class="column column-6" id="sw_version">PENDING</div>
                <div class="column"></div>
              </div>
              <div class="columns">
                <div class="column"><label class="form-label" for="hw_version">Hardware Version:</label></div>
                <div class="column column-6" id="hw_version">PENDING</div>
                <div class="column"></div>
              </div>
              <div id="node_info_dynamic"></div>
        </div>
        <div class="container" style="display:none;" id="tab-olcbconfig">
            <div id="config_dynamic"></div>
            <div class="columns">
                <div class="column"><button class="btn btn-primary btn-sm" onclick="refresh_all_cdi_fields()">Refresh All</button></div>
                <div class="column"><button class="btn btn-primary btn-sm" onclick="factory_reset();">Factory Reset</button></div>
                <div class="column"><button id='bootloader' class="btn btn-primary btn-sm" onclick="request_bootloader();">Enter Bootloader</button></div>
                <div class="column"><button class="btn btn-primary btn-sm" onclick="reset_events();">Reset Events</button></div>
                <div class="column"><button class="btn btn-primary btn-sm" onclick="update_complete();" id='btn-update-complete'>Update Complete</button></div>
                <div class="column"><input class='form-input' id='max_cdi_workers' type='number' min='25' max='150' value='25' hidden/></div>
            </div>
        </div>
        <div class="container" style="display:none;" id="tab-ota">
            <div class="columns">
              <form id="cs-ota-form" class="form-horizontal">
                <div class="input-group">
                  <span class="input-group-addon addon-lg text-light bg-dark">Firmware:</span>
                  <input class="form-input input-lg" type="file" name="firmware_file"
                    placeholder="Esp32OlcbIO.bin" />
                  <button class="btn btn-primary input-group-btn btn-lg" id="btn-firmware_upload" onclick="upload_ota()">Upload</button>
                </div>
              </form>
            </div>
        </div>
    </div>
    <script>
        var ws_pending = [];
        var ws;
        var has_pwm = false;
        const ws_retry_connection_timeout_ms = 500;
        const page_reload_delay_ms = 7500;
        function showTab(target, button) {
            $('[id^=tab-]').hide();
            $(button).parent().children().removeClass('active');
            $(button).parent().children().addClass('inactive');
            $(button).toggleClass('active');
            $(button).toggleClass('inactive');
            $(target).show();
        }
        function showCDISection(section) {
            $('[id^=cdi_tab_]').hide();
            $(String.format('#cdi_tab_{0}', section)).show();
        }
        function showErrorDialog(text, error) {
            error = typeof error !== 'undefined' ? error : "";
            console.error(text, error);
            alert(text);
        }
        function reload_page() {
            ws_cleanup();
            setTimeout(function () { location.reload(); }, page_reload_delay_ms);
        }
        function ws_cleanup() {
            if (ws) {
                ws.removeEventListener('open', ws_opened);
                ws.removeEventListener('message', ws_rx);
                ws.removeEventListener('error', ws_closed);
                ws.removeEventListener('close', ws_closed);
                ws.close();
            }
        }
        function ws_opened(event) {
            $('#ws-status').removeClass('flash text-dark');
            $('#ws-status').addClass('text-success');
            while (ws_pending.length) {
                ws.send(ws_pending.pop());
            }
        }
        function ws_closed(event) {
            $('#ws-status').addClass('text-dark');
            $('#ws-status').removeClass('text-success');
            console.warn('WS closed, reconnecting. Reason:', event.reason);
        }
        function connectWebSocket() {
            if (!window.location.host.length) {
                while (ws_pending.length) {
                    console.log('WS-OFFLINE:', ws_pending.pop());
                }
                return;
            }
            $('#ws-status').addClass('flash');
            var socketUrl = String.format('ws://{0}:{1}/ws', window.location.host, window.location.port);
            try {
                ws = new WebSocket(socketUrl);
                ws.addEventListener('open', ws_opened);
                ws.addEventListener('message', ws_rx);
                ws.addEventListener('error', ws_closed);
                ws.addEventListener('close', ws_closed);
            } catch (e) {
                console.error('Failed to connect to the node, will retry');
                $('#ws-status').addClass('text-dark');
                $('#ws-status').removeClass('flash text-success');
                setTimeout(connectWebSocket, ws_retry_connection_timeout_ms);
            }
        }
        function ws_rx(event) {
            var messages = event.data.split(/[\r\n]+/);
            messages.forEach(msg => {
                if (msg.length > 0) {
                    console.debug('WS-RX:', msg);
                    var json = JSON.parse(msg);
                    if (!json.hasOwnProperty('res')) {
                        console.error('Invalid JSON payload (missing res element):', msg);
                    } else if (json.res === 'error') {
                        showErrorDialog(json.error);
                    } else if (json.res === 'info') {
                        $('#node_id').val(pad_hex(json.node_id, 12));
                        $('#sw_version').text(json.snip_sw);
                        $('#hw_version').text(json.snip_hw);
                        $('#btn-save_node_id').removeClass('loading');
                        if (json.twai === false) {
                            $('#bootloader').hide();
                        } else {
                            $('#bootloader').show();
                        }
                        if (json.pwm === false) {
                            $('#pwm-cfg-tab').hide();
                        } else {
                            $('#pwm-cfg-tab').show();
                            has_pwm = true;
                        }
                        disable_button('update-complete');
                        fetch("/cdi.xml").then(res => res.text()).then(cdi => build_cdi_dom(cdi));
                    } else if (json.res === 'saved') {
                        reset_cdi_buttons(json.tgt);
                        enable_button('update-complete');
                    } else if (json.res === 'field') {
                        const req = ws_pending_response[json.tgt];
                        if (req) {
                            req(json);
                        }
                        if (json.type === 'evt') {
                            if (parseInt(json.val) == 0) {
                                $('#' + json.tgt).addClass('is-error');
                            }
                            $('#' + json.tgt).val(pad_hex(json.val, 16));
                        } else if (json.type === 'str') {
                            try {
                                $('#' + json.tgt).val(atob(json.val));
                            } catch (error) {
                                console.error(error, json);
                                $('#' + json.tgt).val('decode failure');
                                $('#' + json.tgt).addClass('is-error');
                            }
                        } else {
                            $('#' + json.tgt).val(json.val);
                        }
                        reset_cdi_buttons(json.tgt);
                    } else if (json.res === 'nodeid' || json.res === 'factory-reset') {
                        reload_page();
                    } else if (json.res === 'reset-events') {
                        refresh_all_cdi_fields();
                    } else if (json.res === 'event') {
                        $('#' + json.tgt).toggleClass('loading');
                    }
                }
            });
        }
        function ws_tx(msg) {
            // if the socket is not in an open state, defer the send until we have connected
            if (!ws || ws.readyState != WebSocket.OPEN) {
                ws_pending.push(msg);
                // if we are not already trying to connect try and connect now
                if (!ws || ws.readyState != WebSocket.CONNECTING) {
                    connectWebSocket();
                }
                return;
            }
            console.debug('WS-TX:', msg);
            ws.send(msg);
        }
        function save_node_id(button) {
            $(button).addClass('loading');
            disable_button('save_node_id');
            ws_tx(JSON.stringify({
                req: 'nodeid',
                val: $('#node_id').val()
            }));
        }
        function update_complete() {
            ws_tx(JSON.stringify({ req: 'update-complete' }));
        }
        function pad_hex(str, length) {
            var hex = new Array(length + 1).join('0') + str;
            return hex.substr(-length).match(/.{1,2}/g).join('.');
        }
        function enable_button(field) {
            $('#btn-' + field).removeAttr('disabled');
        }
        function disable_button(field) {
            $('#btn-' + field).attr('disabled', true);
        }
        function factory_reset() {
            if (confirm('Are you sure you want to perform a Factory Reset?')) {
                ws_tx(JSON.stringify({ req: 'factory-reset' }));
            }
        }
        function reset_events() {
            if (confirm('Are you sure you want to reset all event IDs?')) {
                ws_tx(JSON.stringify({ req: 'reset-events' }));
            }
        }
        function upload_ota() {
            var xhr = new XMLHttpRequest();
            var file = $('#firmware_file')[0].files[0];
            if (file.size > (1024 * 1024 * 1.5)) {
                showErrorDialog("Firmware is too large for upload, aborting!");
                return;
            }
            var data = new FormData();
            data.append('firmware', file);
            $('#btn-firmware_upload').hide();
            $('#firmware_upload_results').empty();
            fetch('/ota', { method: 'POST', body: data })
                .then(response => response.text())
                .then(text => {
                    reload_page();
                })
                .catch((error) => {
                    showErrorDialog("Firmware upload failed.", error);
                    $('#btn-firmware_upload').show();
                });
        }
        $(function () {
            if (!String.format) {
                String.format = function (format) {
                    var args = Array.prototype.slice.call(arguments, 1);
                    return format.replace(/{(\d+)}/g, function (match, number) {
                        return typeof args[number] != 'undefined'
                            ? args[number]
                            : match
                            ;
                    });
                };
            }
            ws_tx(JSON.stringify({ req: 'info' }));
            window.addEventListener('beforeunload', ws_cleanup);
            $('#max_cdi_workers').hide();
        });

        function toggleModal()
        {

        }

        function build_cdi_dom(cdi) {
            var cdi_doc = parseXML(cdi.slice(0, -1).trim());
            $(cdi_doc).find('segment').each((x, seg) => {
                var segment = new CdiSegment(seg, $('#node_id').val());
                $('#node-cdi-status').text(String.format('Processing {0}', segment.get_name));
                if (segment.is_space(CDI_SPACE_ACDI_USER)) {
                    segment.render('#node_info_dynamic');
                } else if (segment.is_space(CDI_SPACE_CONFIG)) {
                    segment.render('#config_dynamic');
                }
            });
            download_cdi_fields();
        }
    </script>
</body>