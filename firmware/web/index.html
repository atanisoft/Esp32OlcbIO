<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ESP32 OpenLCB IO Configuration Portal</title>
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml;charset=US-ASCII,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22iso-8859-1%22%3F%3E%3C!DOCTYPE%20svg%20PUBLIC%20%22-%2F%2FW3C%2F%2FDTD%20SVG%201.1%2F%2FEN%22%20%22http%3A%2F%2Fwww.w3.org%2FGraphics%2FSVG%2F1.1%2FDTD%2Fsvg11.dtd%22%3E%3Csvg%20version%3D%221.1%22%20id%3D%22Layer_1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20x%3D%220px%22%20y%3D%220px%22%20%20width%3D%2214px%22%20height%3D%2214px%22%20viewBox%3D%220%200%2014%2014%22%20style%3D%22enable-background%3Anew%200%200%2014%2014%3B%22%20xml%3Aspace%3D%22preserve%22%3E%3Cpath%20d%3D%22M13.621%2C5.904l-1.036-0.259c-0.168-0.042-0.303-0.168-0.355-0.332c-0.092-0.284-0.205-0.559-0.339-0.82%20c-0.079-0.153-0.073-0.337%2C0.017-0.486l0.549-0.915c0.118-0.196%2C0.088-0.448-0.075-0.61l-0.862-0.863%20c-0.162-0.163-0.414-0.193-0.611-0.075l-0.916%2C0.55C9.844%2C2.182%2C9.659%2C2.188%2C9.506%2C2.109C9.244%2C1.975%2C8.97%2C1.861%2C8.686%2C1.77%20c-0.165-0.052-0.29-0.187-0.332-0.354L8.095%2C0.379C8.039%2C0.156%2C7.839%2C0%2C7.609%2C0H6.391c-0.229%2C0-0.43%2C0.156-0.485%2C0.379L5.646%2C1.415%20C5.604%2C1.582%2C5.479%2C1.718%2C5.313%2C1.77c-0.284%2C0.092-0.559%2C0.206-0.82%2C0.34C4.339%2C2.188%2C4.155%2C2.182%2C4.007%2C2.093L3.092%2C1.544%20c-0.196-0.118-0.448-0.087-0.61%2C0.075L1.619%2C2.481C1.457%2C2.644%2C1.426%2C2.896%2C1.544%2C3.093l0.549%2C0.914%20c0.089%2C0.148%2C0.095%2C0.332%2C0.017%2C0.486C1.975%2C4.755%2C1.861%2C5.029%2C1.77%2C5.314c-0.053%2C0.164-0.188%2C0.29-0.354%2C0.332L0.379%2C5.905%20C0.156%2C5.961%2C0%2C6.161%2C0%2C6.391v1.219c0%2C0.229%2C0.156%2C0.43%2C0.379%2C0.485l1.036%2C0.26C1.582%2C8.396%2C1.717%2C8.521%2C1.77%2C8.687%20c0.092%2C0.284%2C0.205%2C0.559%2C0.34%2C0.82C2.188%2C9.66%2C2.182%2C9.844%2C2.093%2C9.993l-0.549%2C0.915c-0.118%2C0.195-0.087%2C0.448%2C0.075%2C0.61%20l0.862%2C0.862c0.162%2C0.163%2C0.414%2C0.193%2C0.61%2C0.075l0.915-0.549c0.148-0.089%2C0.332-0.095%2C0.486-0.017%20c0.262%2C0.135%2C0.536%2C0.248%2C0.82%2C0.34c0.165%2C0.053%2C0.291%2C0.187%2C0.332%2C0.354l0.259%2C1.036C5.96%2C13.844%2C6.16%2C14%2C6.39%2C14h1.22%20c0.229%2C0%2C0.43-0.156%2C0.485-0.379l0.259-1.036c0.042-0.167%2C0.168-0.302%2C0.333-0.354c0.284-0.092%2C0.559-0.205%2C0.82-0.34%20c0.154-0.078%2C0.338-0.072%2C0.486%2C0.017l0.914%2C0.549c0.197%2C0.118%2C0.449%2C0.088%2C0.611-0.074l0.862-0.863%20c0.163-0.162%2C0.193-0.415%2C0.075-0.611l-0.549-0.915c-0.089-0.148-0.096-0.332-0.017-0.485c0.134-0.263%2C0.248-0.536%2C0.339-0.82%20c0.053-0.165%2C0.188-0.291%2C0.355-0.333l1.036-0.259C13.844%2C8.039%2C14%2C7.839%2C14%2C7.609V6.39C14%2C6.16%2C13.844%2C5.96%2C13.621%2C5.904z%20M7%2C10%20c-1.657%2C0-3-1.343-3-3s1.343-3%2C3-3s3%2C1.343%2C3%2C3S8.657%2C10%2C7%2C10z%22%2F%3E%3Cg%3E%3C%2Fg%3E%3Cg%3E%3C%2Fg%3E%3Cg%3E%3C%2Fg%3E%3Cg%3E%3C%2Fg%3E%3Cg%3E%3C%2Fg%3E%3Cg%3E%3C%2Fg%3E%3Cg%3E%3C%2Fg%3E%3Cg%3E%3C%2Fg%3E%3Cg%3E%3C%2Fg%3E%3Cg%3E%3C%2Fg%3E%3Cg%3E%3C%2Fg%3E%3Cg%3E%3C%2Fg%3E%3Cg%3E%3C%2Fg%3E%3Cg%3E%3C%2Fg%3E%3Cg%3E%3C%2Fg%3E%3C%2Fsvg%3E"
        sizes="any">
    <script src="cash.min.js"></script>
    <link rel="stylesheet" href="spectre.min.css">
    <style>
        fieldset {
            border-style: solid;
            border-width: 0.1rem;
            border-color: #606c76;
            border-radius: 0.5rem;
        }

        #ws-status.flash {
            animation-name: colorflash;
            animation-duration: 1s;
            animation-iteration-count: infinite;
            animation-timing-function: linear;
        }

        @keyframes colorflash {
            0% {
                filter: invert(0.8) sepia(1) saturate(3);
            }

            50% {
                filter: invert(0.5);
            }

            100% {
                filter: invert(0.8) sepia(1) saturate(3);
            }
        }
    </style>
</head>

<body>
    <div class="hero hero-sm bg-gray">
        <div class="hero-body">
            <h1>ESP32 IO Board Configuration
                <div class="btn-group float-right">
                    <div class="tooltip tooltip-left" data-tooltip="Connection status"><i id="ws-status"
                            class="icon icon-wifi text-dark"></i></div>
                </div>
            </h1>
        </div>
    </div>
    <div class="container">
        <ul class="tab tab-block">
            <li class="tab-item">
                <a href="#" onclick="showTab('node_info', this, 'tab-');">Node Information</a>
            </li>
            <li class="tab-item">
                <a href="#" onclick="showTab('firmware_upload', this, 'tab-');">Firmware Update</a>
            </li>
            <li class="tab-item">
                <a href="#" onclick="showTab('config', this, 'tab-');">Node Configuration</a>
            </li>
        </ul>
        <div class="container" id="tab-node_info">
            <div class="columns">
                <div class="column"><label class="form-label" for="node_id">Node ID:</label></div>
                <div class="column column-6"><input class="form-input" id="node_id"
                        oninput="enable_button('save_node_id');">
                </div>
                <div class="column"><button class="btn btn-primary btn-sm" id="btn-save_node_id" disabled
                        onclick="save_node_id(this);">Save</button></div>
            </div>
            <div class="columns">
                <div class="column"><label class="form-label" for="sw_version">Software Version:</label></div>
                <div class="column column-6" id="sw_version">PENDING</div>
                <div class="column"></div>
            </div>
            <div class="columns">
                <div class="column"><label class="form-label" for="hw_version">Hardware Version:</label></div>
                <div class="column column-6" id="hw_version">PENDING</div>
                <div class="column"></div>
            </div>
            <div id="node_info_dynamic"></div>
            <div class="columns">
                <div class="column"><button class="btn btn-primary btn-sm" onclick="factory_reset();">Factory
                        Reset</button>
                </div>
                <div class="column" id="bootloader"><button class="btn btn-primary btn-sm"
                        onclick="request_bootloader();">Enter
                        Bootloader</button>
                </div>
                <div class="column"><button class="btn btn-primary btn-sm" onclick="reset_events();">Reset
                        Events</button></div>
            </div>
        </div>
        <div class="container" style="display:none;" id="tab-firmware_upload">
            <div class="columns">
                <form id="cs-ota-form" class="form-horizontal">
                    <div class="input-group">
                        <span class="input-group-addon addon-lg">Firmware:</span>
                        <input class="form-input input-lg" type="file" name="firmware_file" accept=".bin"
                            placeholder="ESP32OlcbIO.bin" />
                        <button class="btn btn-primary input-group-btn btn-lg" onclick="upload_ota()">Upload</button>
                    </div>
                </form>
            </div>
        </div>
        <div class="container" style="display:none;" id="tab-config">
            <ul class="tab tab-block">
                <li class="tab-item">
                    <a href="#" onclick="showTab('wifi', this, 'cdi_tab_');">WiFi Configuration</a>
                </li>
                <li class="tab-item">
                    <a href="#" onclick="showTab('gpi', this, 'cdi_tab_');">Inputs</a>
                </li>
                <li class="tab-item">
                    <a href="#" onclick="showTab('gpio', this, 'cdi_tab_');">Inputs/Outputs</a>
                </li>
                <li class="tab-item" id="cfg_pwm" style="display:none;">
                    <a href="#" onclick="showTab('pwm', this, 'cdi_tab_');">PWM</a>
                </li>
            </ul>
            <div class="container" id="cdi_tab_wifi">
            </div>
            <div class="container" id="cdi_tab_gpi" style="display:none;">
            </div>
            <div class="container" id="cdi_tab_gpio" style="display:none;">
            </div>
            <div class="container" id="cdi_tab_pwm" style="display:none;">
            </div>
            <div class="columns">
                <div class="column"><button class="btn btn-primary btn-sm" onclick="factory_reset();">Factory
                        Reset</button>
                </div>
                <div class="column"><button class="btn btn-primary btn-sm" onclick="reset_events();">Reset
                        Events</button></div>
                <div class="column"><button class="btn btn-primary btn-sm" onclick="refresh_all_cdi_fields()">Refresh
                        All</button></div>
                <div class="column"><button class="btn btn-primary btn-sm" onclick="update_complete();">Update
                        Complete</button></div>
            </div>
        </div>
    </div>
    <script>
        const ws_retry_connection_timeout_ms = 500;
        const ws_ping_timeout_ms = 2000;
        const ws_ping_interval_ms = 5000;
        const page_reload_delay_ms = 7500;
        const fetch_timeout_ms = 10000;
        var ws = null;
        var ws_pending_send = [];
        var ws_req_id = 0;
        var has_pwm = false;
        var cdi_loaded = false;
        var cdi_loaders = [];
        var ws_ping_timer_id = 0;
        var ws_ping_interval_timer_id = 0;

        function get_ws_msg_id() {
            ws_req_id++;
            return ws_req_id;
        }
        async function fetchWithTimeout(resource, options) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), fetch_timeout_ms);
            const response = await fetch(resource, {
                ...options,
                signal: controller.signal
            });
            clearTimeout(id);
            if (!response.ok) {
                const message = `An error has occured: ${response.status}`;
                throw new Error(message);
            }
            return response;
        }
        function showTab(target, link, tab_prefix) {
            $(String.format('[id^={0}]', tab_prefix)).hide();
            $(link).parent().parent().children().removeClass('active');
            $(link).parent().addClass('active');
            if (tab_prefix === 'tab-' && target === 'config') {
                $(link).toggleClass('loading');
                refreshCDI(link);
            } else {
                $(String.format('#{0}{1}', tab_prefix, target)).show();
            }
        }
        function showErrorDialog(text, error) {
            error = typeof error !== 'undefined' ? error : "";
            console.error(text, error);
            alert(text);
        }
        function reload_page() {
            clearInterval(ws_ping_interval_timer_id);
            ws_cleanup();
            setTimeout(function () { location.reload(); }, page_reload_delay_ms);
        }
        function ws_cleanup() {
            clearInterval(ws_ping_interval_timer_id);
            clearTimeout(ws_ping_timer_id);
            if (ws) {
                ws.removeEventListener('open', ws_opened);
                ws.removeEventListener('message', ws_rx);
                ws.removeEventListener('error', ws_closed);
                ws.removeEventListener('close', ws_closed);
                ws.close();
            }
        }
        function ws_dead() {
            ws_cleanup();
            connectWebSocket();
        }
        function ws_ping() {
            ws_ping_timer_id = setTimeout(ws_dead, ws_ping_timeout_ms);
            ws_tx(JSON.stringify({
                req: 'ping',
                id: get_ws_msg_id()
            }));
        }
        function ws_rx(event) {
            var messages = event.data.split(/[\r\n]+/);
            messages.forEach(msg => {
                if (msg.length > 0) {
                    console.debug('WS-RX:', msg);
                    var json = JSON.parse(msg);
                    if (!json.hasOwnProperty('res')) {
                        console.error('Invalid JSON payload (missing res element):', msg);
                    } else if (json.res === 'error') {
                        showErrorDialog(json.error);
                    } else if (json.res === 'info') {
                        $('#node_id').val(pad_hex(json.node_id, 12));
                        $('#sw_version').text(json.snip_sw);
                        $('#hw_version').text(json.snip_hw);
                        $('#btn-save_node_id').removeClass('loading');
                        if (json.twai === false) {
                            $('#bootloader').hide();
                        } else {
                            $('#bootloader').show();
                        }
                        has_pwm = json.pwm;
                    } else if (json.res === 'saved') {
                        reset_cdi_buttons(json.tgt);
                    } else if (json.res === 'field') {
                        if (json.type === 'evt') {
                            $('#' + json.tgt).val(pad_hex(json.val, 16));
                        } else {
                            $('#' + json.tgt).val(json.val);
                        }
                        reset_cdi_buttons(json.tgt);
                    } else if (json.res === 'nodeid' || json.res === 'factory-reset') {
                        reload_page();
                    } else if (json.res === 'reset-events') {
                        refresh_all_cdi_fields();
                    } else if (json.res === 'pong') {
                        clearTimeout(ws_ping_timer_id);
                    }
                }
            });
        }
        function ws_tx(msg) {
            // if the socket is not in an open state, defer the send until we have connected
            if (!ws || ws.readyState != WebSocket.OPEN) {
                ws_pending_send.push(msg);
                // if we are not already trying to connect try and connect now
                if (!ws || ws.readyState != WebSocket.CONNECTING) {
                    connectWebSocket();
                }
                return;
            }
            console.debug('WS-TX:', msg);
            ws.send(msg);
        }
        function ws_opened(event) {
            $('#ws-status').removeClass('flash text-dark');
            $('#ws-status').addClass('text-success');
            while (ws_pending_send.length) {
                ws.send(ws_pending_send.pop());
            }
            ws_ping_interval_timer_id = setInterval(ws_ping, ws_ping_interval_ms);
        }
        function ws_closed(event) {
            clearTimeout(ws_ping_timer_id);
            clearInterval(ws_ping_interval_timer_id);
            console.warn('WS closed, reconnecting. Reason:', event.reason);
            $('#ws-status').addClass('text-dark');
            $('#ws-status').removeClass('text-success');
            setTimeout(connectWebSocket, ws_retry_connection_timeout_ms);
        }
        function connectWebSocket() {
            if (!window.location.host.length) {
                while (ws_pending_send.length) {
                    console.log('WS-OFFLINE:', ws_pending_send.pop());
                }
                return;
            }
            $('#ws-status').addClass('flash');
            var socketUrl = String.format('ws://{0}:{1}/ws', window.location.host, window.location.port);
            try {
                ws = new WebSocket(socketUrl);
                ws.addEventListener('open', ws_opened);
                ws.addEventListener('message', ws_rx);
                ws.addEventListener('error', ws_closed);
                ws.addEventListener('close', ws_closed);
            } catch (e) {
                console.error('Connection failed, will retry');
                $('#ws-status').addClass('text-dark');
                $('#ws-status').removeClass('flash text-success');
                setTimeout(connectWebSocket, ws_retry_connection_timeout_ms);
            }
        }
        $(function () {
            if (!String.format) {
                String.format = function (format) {
                    var args = Array.prototype.slice.call(arguments, 1);
                    return format.replace(/{(\d+)}/g, function (match, number) {
                        return typeof args[number] != 'undefined'
                            ? args[number]
                            : match
                            ;
                    });
                };
            }
            if (window.location.host.length) {
                ws_tx(JSON.stringify({
                    req: 'info',
                    id: get_ws_msg_id()
                }));
                window.addEventListener('beforeunload', ws_cleanup);
            }
        });

        function refresh_all_cdi_fields() {
            $('[id^=btn-refresh-]').each(function (i, e) {
                refresh_cdi_field(e);
            });
        }
        function refreshCDI(button) {
            if (!cdi_loaded) {
                fetchWithTimeout("/cdi.xml").then(res => res.text()).then(cdi => build_cdi_dom(cdi, button));
            } else {
                refresh_all_cdi_fields();
                $(button).toggleClass('loading');
                $('#tab-config').show();
            }
        }
        function save_node_id(button) {
            $(button).addClass('loading');
            disable_button('save_node_id');
            ws_tx(JSON.stringify({
                req: 'nodeid',
                val: $('#node_id').val(),
                id: get_ws_msg_id()
            }));
        }
        function build_cdi_dom(cdi, button) {
            cdi_loaders.splice(0, cdi_loaders.length);
            var parser = new window.DOMParser();
            var doc = parser.parseFromString(cdi, "text/xml");
            var offsets_251 = calculate_offsets(doc, 251);
            var offsets_253 = calculate_offsets(doc, 253);
            cdi_dynamic_group(doc, 251, 'node_info', '#node_info_dynamic', offsets_251, '//segment[@space="251"]');
            cdi_dynamic_group(doc, 253, 'WiFi Configuration', '#cdi_tab_wifi', offsets_253);
            cdi_dynamic_group(doc, 253, 'Input Only Pins', '#cdi_tab_gpi', offsets_253);
            cdi_dynamic_group(doc, 253, 'Input Output Pins', '#cdi_tab_gpio', offsets_253);
            if (has_pwm) {
                cdi_dynamic_group(doc, 253, 'PWM', '#cdi_tab_pwm', offsets_253);
                $('#cfg_pwm').show();
            } else {
                $('#cfg_pwm').hide();
            }
            cdi_loaders.forEach(elem => ws_tx(elem));
            cdi_loaders.splice(0, cdi_loaders.length);
            $('#tab-config').show();
            $(button).toggleClass('loading');
            cdi_loaded = true;
        }
        function save_cdi_field(field) {
            var target = $(field).attr('id').substr(9);
            $(field).toggleClass('loading');
            var size = parseInt($('#' + target).data('size'));
            var type = $('#' + target).data('type');
            var value = $('#' + target).val()
            if (type === 'str') {
                if (value.length < size) {
                    size = value.length;
                } else {
                    value = value.substr(0, size);
                }
            }
            ws_tx(JSON.stringify({
                req: 'cdi',
                ofs: parseInt($('#' + target).data('offset')),
                sz: size,
                type: type,
                tgt: target,
                val: value,
                id: get_ws_msg_id()
            }));
        }
        function refresh_cdi_field(field) {
            var target = $(field).attr('id').substr(12);
            $(field).toggleClass('loading');
            ws_tx(JSON.stringify({
                req: 'cdi',
                ofs: $('#' + target).data('offset'),
                sz: $('#' + target).data('size'),
                type: $('#' + target).data('type'),
                tgt: target,
                id: get_ws_msg_id()
            }));
        }
        function factory_reset() {
            if (confirm('Are you sure you want to perform a Factory Reset?')) {
                ws_tx(JSON.stringify({
                    req: 'factory-reset',
                    id: get_ws_msg_id()
                }));
            }
        }
        function request_bootloader() {
            if (confirm('Are you sure you want to enter the bootloader?')) {
                ws_tx(JSON.stringify({
                    req: 'bootloader',
                    id: get_ws_msg_id()
                }));
                clearInterval(ws_ping_interval_timer_id);
                clearTimeout(ws_ping_timer_id);
                if (ws) {
                    ws.removeEventListener('error', ws_closed);
                    ws.removeEventListener('close', ws_closed);
                }
                alert('The request to enter the bootloader has sent.\n\nOnce the node returns to normal operating mode, you will need to manually refresh this page.');
            }
        }
        function reset_events() {
            if (confirm('Are you sure you want to reset all event IDs?')) {
                ws_tx(JSON.stringify({
                    req: 'reset-events',
                    id: get_ws_msg_id()
                }));
            }
        }
        function test_event(target) {
            var field = $(target).attr('id').substr(9);
            var event = $('#' + field).val();
            ws_tx(JSON.stringify({req:'event', evt:event, id: get_ws_msg_id()}));
        }
        function update_complete() {
            ws_tx(JSON.stringify({
                req: 'update-complete',
                id: get_ws_msg_id()
            }));
        }
        function reset_cdi_buttons(target) {
            $(String.format('#btn-refresh-{0}', target)).removeClass('loading');
            $(String.format('#btn-save-{0}', target)).removeClass('loading');
            enable_button('refresh-' + target);
            disable_button('save-' + target);
        }
        function pad_hex(str, length) {
            var hex = new Array(length + 1).join('0') + str;
            return hex.substr(-length).match(/.{1,2}/g).join('.');
        }
        function enable_button(field) {
            console.debug('enabling:', '#btn-' + field);
            $('#btn-' + field).removeAttr('disabled');
        }
        function disable_button(field) {
            console.debug('disabling:', '#btn-' + field);
            $('#btn-' + field).attr('disabled', true);
        }
        function process_group(group) {
            var groupsize = 0;
            if (group.nodeName == 'int' || group.nodeName == 'string') {
                groupsize += parseInt($(group).attr('size'));
            } else if (group.nodeName == 'eventid') {
                groupsize += 8;
            } else if (group.nodeName == 'group') {
                if ($.isNumeric($(group).attr('offset'))) {
                    groupsize += parseInt($(group).attr('offset'));
                }
                $(group).children().each(function (i, c) {
                    groupsize += process_group(c);
                });
            }
            return groupsize;
        }
        function calculate_offsets(cdi, space) {
            var offsets = {};
            var segment = $(cdi).find('segment').filter(
                function (i, e) {
                    return parseInt($(e).attr('space')) === space && parseInt($(e).attr('origin')) > 0;
                });
            var offs = parseInt($(segment).attr('origin'));
            $(segment).children().each(function (i, e) {
                var group_name = 'unknown';
                if (space === 251) {
                    group_name = 'node_info';
                } else {
                    $(e.children).each(function (i, e) {
                        if (e.nodeName === 'name') {
                            group_name = $(e).text();
                        }
                    });
                }
                var replica_count = 1;
                if ($(e).attr('replication')) {
                    replica_count = parseInt($(e).attr('replication'));
                }
                var groupsize = 0;
                $(e.children).each(function (i, c) {
                    groupsize += process_group(c);
                });
                offsets[group_name] = { size: groupsize, replicas: replica_count, offset: offs };
                offs += (groupsize * replica_count);
            });
            return offsets;
        }
        function generate_cdi_dynamic_content(space, group, offset) {
            var size = 0;
            // these nodes can be safely dropped from rendering
            if (group.nodeName === 'name' || group.nodeName === 'description' || group.nodeName === 'repname') {
                return ['', 0];
            }
            var content = '';
            var node_data_type = group.nodeName;
            var node_name = '';
            var is_mapped = false;
            var mapped = undefined;
            var node_description = '';
            var node_alias = String.format('cdi_{0}', Math.random()).replace(/\./g, '_');
            for (child = 0; child < group.children.length; child++) {
                if (group.children[child].nodeName === 'name') {
                    node_name = $(group.children[child]).text();
                } else if (group.children[child].nodeName === 'map') {
                    is_mapped = true;
                    mapped = group.children[child];
                } else if (group.children[child].nodeName === 'description') {
                    node_description = $(group.children[child]).text().replace(/\n/g, '<br/>');
                }
            };
            if (is_mapped) {
                size = parseInt($(group).attr('size'));
                console.groupCollapsed('Mapped:', node_name, 'offset:', offset, 'size:', size, 'description:', node_description);
                content += '<div class="columns">';
                content += String.format('<div class="column"><label for="{0}">{1}:</label></div>', node_alias, node_name);
                content += String.format('<div class="column column-6"><select id="{0}" data-offset="{1}" data-type="{2}" data-size="{3}" oninput="enable_button(\'save-{0}\')">', node_alias, offset, node_data_type, size);
                $(mapped.children).each(function (i, e) {
                    console.log($(e).find('value').text(), '=>', $(e).find('property').text());
                    content += String.format('<option value="{0}">{1}</option>', $(e).find('property').text(), $(e).find('value').text());
                });
                content += '</select></div>';
                content += String.format('<div class="column"><div class="btn-group"><button class="btn btn-primary btn-sm" id="btn-save-{0}" disabled onclick="save_cdi_field(this);">Save</button>', node_alias);
                content += String.format('<button class="btn btn-primary btn-sm loading" id="btn-refresh-{0}" onclick="refresh_cdi_field(this);">Refresh</button></div>', node_alias);
                content += '</div></div>';
                content += String.format('<div class="columns"><div class="column"><small>{0}</small></div></div>', node_description);
                cdi_loaders.push(JSON.stringify({
                    req: 'cdi',
                    ofs: offset,
                    sz: size,
                    type: node_data_type,
                    tgt: node_alias,
                    id: get_ws_msg_id()
                }));
                console.groupEnd();
            } else if (node_data_type === 'group') {
                if ($.isNumeric(parseInt($(group).attr('offset'))) && node_name === '') {
                    size = parseInt($(group).attr('offset'));
                    node_name = 'hidden'
                }
                if (group.children.length > 0) {
                    if (node_name != '') {
                        content += String.format('<fieldset><legend>{0}:</legend>', node_name);
                        console.groupCollapsed(node_name);
                    } else {
                        console.groupCollapsed('unnamed group');
                    }
                    content += String.format('<div class="columns"><div class="column"><small>{0}</small></div></div>', node_description);
                    $(group.children).each(function (i, e) {
                        var res = generate_cdi_dynamic_content(space, e, offset + size);
                        content += res[0];
                        size += res[1];
                    });
                    console.groupEnd();
                    if (node_name != '') {
                        content += '</fieldset>';
                    }
                }
            } else if (node_name !== '') {
                if (node_data_type === 'eventid') {
                    size = 8; // events are always 8 bytes
                    node_data_type = 'evt';
                } else {
                    if (node_data_type === 'string') {
                        node_data_type = 'str';
                    }
                    size = parseInt($(group).attr('size'));
                }
                console.log('Entry:', node_name, 'offset:', offset, 'size:', size, 'datatype:', node_data_type, 'description:', node_description);
                content += '<div class="columns">';
                content += String.format('<div class="column"><label class="form-label" for="{0}">{1}:</label></div>', node_alias, node_name);
                content += String.format('<div class="column column-6"><input class="form-input" type="text" id="{0}" data-offset="{1}" data-type="{2}" data-size="{3}" oninput="enable_button(\'save-{0}\')"></div>', node_alias, offset, node_data_type, size);
                content += String.format('<div class="column"><div class="btn-group"><button class="btn btn-primary btn-sm" id="btn-save-{0}" disabled onclick="save_cdi_field(this);">Save</button>', node_alias);
                content += String.format('<button class="btn btn-primary btn-sm loading" id="btn-refresh-{0}" onclick="refresh_cdi_field(this);">Refresh</button></div>', node_alias);
                if (node_data_type === 'evt') {
                    content += String.format('<button class="btn btn-primary btn-sm" id="btn-test-{0}" onclick="test_event(this);">Test</button>', node_alias);
                }
                content += '</div></div>';
                content += String.format('<div class="columns"><div class="column"><small>{0}</small></div></div>', node_description)
                cdi_loaders.push(JSON.stringify({
                    req: 'cdi',
                    ofs: offset,
                    sz: size,
                    type: node_data_type,
                    tgt: node_alias,
                    id: get_ws_msg_id()
                }));
            }
            return [content, size];
        }
        function cdi_dynamic_group(cdi, space, group, target_selector, offsets, xpath = String.format("//segment[@space='{0}']/group[name[text()='{1}']]", space, group)) {
            var nodes = cdi.evaluate(xpath, cdi);
            var node = nodes.iterateNext();
            var offs = offsets[group].offset;
            var group_name = 'unnamed';
            $(node.children).each(function (i, e) {
                if (e.nodeName === 'name') {
                    group_name = $(e).text();
                }
            });
            console.groupCollapsed(group_name, 'segment:', space);
            if (offsets[group].replicas === 1) {
                $(node.children).each(function (i, e) {
                    var rendered = generate_cdi_dynamic_content(space, e, offs);
                    $(target_selector).append(rendered[0]);
                    offs += rendered[1];
                });
            } else {
                var group_tabs = '<ul class="tab tab-block">';
                var group_content = '';
                var alias = $(node).find('repname').text();
                var group_id = group.replace(/ /g, '_');
                for (replica = 1; replica <= offsets[group].replicas; replica++) {
                    console.groupCollapsed(alias, replica);
                    group_tabs += String.format('<li class="tab-item"><a href="#" id="{0}-{1}">{2} {1}</a></li>', group_id, replica, alias);
                    group_content += String.format('<div class="container" id="rep-{0}-{1}" style="display:{3};"><fieldset><legend>{2} {1}</legend>', group_id, replica, alias, replica > 1 ? 'none' : 'block');
                    $(node).children().each(function (i, e) {
                        var rendered = generate_cdi_dynamic_content(space, e, offs);
                        group_content += rendered[0];
                        offs += rendered[1];
                    });
                    group_content += '</fieldset></div>';
                    console.groupEnd();
                }
                group_tabs += "</ul>";
                $(target_selector).append(group_tabs);
                $(target_selector).append(group_content);
                $(String.format('[id^={0}-]', group_id)).on('click', function (evt) {
                    $(String.format('[id^=rep-{0}-]', group_id)).hide();
                    var selected_tab = $(evt.target).attr('id');
                    var tab_group = selected_tab.substring(0, selected_tab.lastIndexOf('-'));
                    var tab_content = String.format('#rep-{0}', selected_tab);
                    $(tab_content).show();
                    $(evt.target).parent().children().removeClass('active');
                    $(evt.target).parent().addClass('active');
                });
            }
            console.groupEnd();
        }
    </script>
</body>